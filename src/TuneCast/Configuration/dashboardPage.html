<!DOCTYPE html>
<html>
<head>
    <title>TuneCast Dashboard</title>
</head>
<body>
    <div id="TuneCastDashboardPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-button">
        <div data-role="content">
            <div class="content-primary">
                <div id="jpRoot"></div>
            </div>
        </div>

        <script type="text/javascript">
            (function() {
                /* ── SVG Icons ── */
                var SVG = {
                    tv: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00a4dc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></svg>',
                    phone: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00a4dc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
                    desktop: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00a4dc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
                    web: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00a4dc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
                    gamepad: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00a4dc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/><line x1="15" y1="13" x2="15.01" y2="13"/><line x1="18" y1="11" x2="18.01" y2="11"/><rect x="2" y="6" width="20" height="12" rx="2"/></svg>',
                    apple: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00a4dc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18.7 10.3c-.1 0-2.2-1.2-2.2-3.8 0-2.2 1.8-3.3 1.9-3.3-.9-1.5-2.6-1.7-3.1-1.7-1.3-.1-2.6.8-3.3.8-.7 0-1.7-.8-2.9-.7-1.5.1-2.9.9-3.6 2.2-1.6 2.7-.4 6.7 1.1 8.9.7 1.1 1.6 2.3 2.8 2.2 1.1 0 1.5-.7 2.9-.7 1.3 0 1.7.7 2.9.7 1.2 0 2-1.1 2.7-2.2.9-1.2 1.2-2.4 1.2-2.5-.1.1-2.4-.9-2.4-3.9z"/><path d="M15.4 3.5c.6-.8 1-1.8.9-2.9-1 0-2.1.6-2.8 1.5-.6.7-1.1 1.8-.9 2.8 1 .1 2.1-.6 2.8-1.4z"/></svg>',
                    fire: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ff6d00" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>',
                    cast: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00a4dc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"/><line x1="2" y1="20" x2="2.01" y2="20"/></svg>',
                    film: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00a4dc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>',
                    unknown: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                    play: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#4caf50" stroke="none"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
                    check: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
                    x: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#f44336" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
                    refresh: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>',
                    settings: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>'
                };

                function getIcon(clientType) {
                    var t = String(clientType);
                    var map = {
                        '0': SVG.unknown, 'Unknown': SVG.unknown,
                        '1': SVG.web, 'WebBrowser': SVG.web,
                        '2': SVG.tv, 'AndroidTv': SVG.tv,
                        '3': SVG.phone, 'AndroidMobile': SVG.phone,
                        '4': SVG.cast, 'Roku': SVG.cast,
                        '5': SVG.fire, 'FireTv': SVG.fire,
                        '6': SVG.apple, 'SwiftfinIos': SVG.apple,
                        '7': SVG.apple, 'SwiftfinTvos': SVG.apple,
                        '8': SVG.desktop, 'Desktop': SVG.desktop,
                        '9': SVG.gamepad, 'Xbox': SVG.gamepad,
                        '10': SVG.film, 'Kodi': SVG.film,
                        '11': SVG.cast, 'Dlna': SVG.cast
                    };
                    return map[t] || SVG.unknown;
                }

                function getTypeName(t) {
                    var names = {
                        0: 'Unknown', 1: 'Web Browser', 2: 'Android TV', 3: 'Android Mobile',
                        4: 'Roku', 5: 'Fire TV', 6: 'Swiftfin iOS', 7: 'Swiftfin tvOS',
                        8: 'Desktop', 9: 'Xbox', 10: 'Kodi', 11: 'DLNA',
                        'Unknown': 'Unknown', 'WebBrowser': 'Web', 'AndroidTv': 'Android TV',
                        'AndroidMobile': 'Android', 'Roku': 'Roku', 'FireTv': 'Fire TV',
                        'SwiftfinIos': 'iOS', 'SwiftfinTvos': 'tvOS', 'Desktop': 'Desktop',
                        'Xbox': 'Xbox', 'Kodi': 'Kodi', 'Dlna': 'DLNA'
                    };
                    return names[t] || String(t);
                }

                function V(obj) {
                    for (var i = 1; i < arguments.length; i++) {
                        var key = arguments[i];
                        var camel = key.charAt(0).toLowerCase() + key.slice(1);
                        if (obj[key] !== undefined) return obj[key];
                        if (obj[camel] !== undefined) return obj[camel];
                    }
                    return undefined;
                }

                function timeAgo(ts) {
                    if (!ts) return '';
                    var diff = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
                    if (diff < 60) return 'just now';
                    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
                    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
                    return Math.floor(diff / 86400) + 'd ago';
                }

                function fmtTime(ts) {
                    if (!ts) return '';
                    var d = new Date(ts);
                    return d.toLocaleDateString(undefined, {month:'short',day:'numeric'}) + ' ' +
                           d.toLocaleTimeString(undefined, {hour:'2-digit',minute:'2-digit'});
                }

                function barColor(pct) {
                    if (pct >= 70) return '#4caf50';
                    if (pct >= 40) return '#ff9800';
                    return '#f44336';
                }

                function badge(text, bg, fg) {
                    return '<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;background:' + bg + ';color:' + fg + ';">' + text + '</span>';
                }

                function methodBadge(m) {
                    var method = (m || '').toLowerCase();
                    if (method === 'directplay') return badge('Direct Play', 'rgba(76,175,80,0.2)', '#4caf50');
                    if (method === 'directstream') return badge('Direct Stream', 'rgba(0,164,220,0.2)', '#00a4dc');
                    if (method === 'transcode') return badge('Transcode', 'rgba(255,152,0,0.2)', '#ff9800');
                    return badge(m || 'Unknown', 'rgba(255,255,255,0.08)', 'rgba(255,255,255,0.5)');
                }

                function resultBadge(r) {
                    var s = typeof r === 'string' ? r : '';
                    var n = typeof r === 'number' ? r : -1;
                    if (s === 'Success' || n === 1) return badge('Success', 'rgba(76,175,80,0.2)', '#4caf50');
                    if (s === 'Failure' || n === 2) return badge('Failure', 'rgba(244,67,54,0.2)', '#f44336');
                    if (s === 'SuspectedFailure' || n === 3) return badge('Suspected', 'rgba(244,67,54,0.15)', '#ff9800');
                    if (s === 'Transcoded' || n === 4) return badge('Transcoded', 'rgba(255,152,0,0.2)', '#ff9800');
                    return badge('Unknown', 'rgba(255,255,255,0.08)', 'rgba(255,255,255,0.4)');
                }

                function confBar(label, val) {
                    var pct = Math.round(val * 100);
                    var col = barColor(pct);
                    return '<div style="display:flex;align-items:center;gap:8px;margin:3px 0;">' +
                        '<div style="width:55px;text-align:right;font-family:monospace;font-size:12px;color:rgba(255,255,255,0.6);flex-shrink:0;">' + label + '</div>' +
                        '<div style="flex:1;height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">' +
                            '<div style="width:' + pct + '%;height:100%;background:' + col + ';border-radius:4px;transition:width 0.3s;"></div>' +
                        '</div>' +
                        '<div style="width:36px;text-align:right;font-family:monospace;font-size:11px;color:rgba(255,255,255,0.5);">' + pct + '%</div>' +
                    '</div>';
                }

                /* ── Fetch helper ── */
                function fetchJ(url) {
                    var headers = { 'Content-Type': 'application/json' };
                    var token = ApiClient.accessToken();
                    if (token) headers['Authorization'] = 'MediaBrowser Token="' + token + '"';
                    return fetch(ApiClient.serverAddress() + url, { headers: headers }).then(function(r) { return r.json(); });
                }

                /* ── Render ── */
                function render(summary, clients, telemetry, interventions) {
                    var s = V(summary, 'Stats') || {};
                    var cfg = V(summary, 'Config') || {};
                    var active = V(summary, 'ActiveSessions') || [];
                    var h = '';

                    /* Header */
                    h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">';
                    h += '<div style="display:flex;align-items:center;gap:12px;">';
                    h += '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#00a4dc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
                    h += '<div><div style="font-size:22px;font-weight:700;">TuneCast Dashboard</div>';
                    h += '<div style="font-size:12px;color:rgba(255,255,255,0.4);" id="jpUpdatedAt"></div></div></div>';
                    h += '<button id="jpRefresh" style="display:inline-flex;align-items:center;gap:6px;background:rgba(0,164,220,0.12);color:#00a4dc;border:1px solid rgba(0,164,220,0.25);border-radius:6px;padding:6px 14px;cursor:pointer;font-size:13px;">' + SVG.refresh + ' Refresh</button>';
                    h += '</div>';

                    /* Stat cards */
                    var totalClients = V(s,'TotalClients') || 0;
                    var total7d = V(s,'TotalSessions7d') || 0;
                    var dpRate = V(s,'DirectPlayRate') || 0;
                    var dpCount = V(s,'DirectPlayCount') || 0;
                    var dsCount = V(s,'DirectStreamCount') || 0;
                    var tcCount = V(s,'TranscodeCount') || 0;
                    var failCount = V(s,'FailureCount') || 0;

                    h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:20px;">';
                    var stats = [
                        [totalClients, 'Known Clients', '#00a4dc'],
                        [total7d, 'Sessions (7d)', '#00a4dc'],
                        [dpRate + '%', 'Direct Play Rate', '#4caf50'],
                        [dpCount, 'Direct Play', '#4caf50'],
                        [dsCount, 'Direct Stream', '#2196f3'],
                        [tcCount, 'Transcoded', '#ff9800'],
                        [failCount, 'Failures', '#f44336']
                    ];
                    stats.forEach(function(st) {
                        h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:14px 16px;border-left:3px solid ' + st[2] + ';">';
                        h += '<div style="font-size:28px;font-weight:700;color:' + st[2] + ';line-height:1.1;">' + st[0] + '</div>';
                        h += '<div style="font-size:12px;color:rgba(255,255,255,0.5);margin-top:2px;">' + st[1] + '</div>';
                        h += '</div>';
                    });
                    h += '</div>';

                    /* Active sessions */
                    if (active.length > 0) {
                        h += '<div style="font-size:16px;font-weight:600;margin:18px 0 8px 0;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.08);">';
                        h += SVG.play + ' Now Playing</div>';
                        h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:12px 16px;margin-bottom:16px;">';
                        active.forEach(function(sess) {
                            var dn = V(sess,'DeviceName') || 'Unknown';
                            var cl = V(sess,'Client') || '';
                            var it = V(sess,'ItemName') || '';
                            var pm = V(sess,'PlayMethod') || '';
                            h += '<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);">';
                            h += '<div style="width:8px;height:8px;background:#4caf50;border-radius:50%;"></div>';
                            h += '<div style="font-weight:600;">' + dn + '</div>';
                            h += '<div style="color:rgba(255,255,255,0.4);font-size:13px;">' + cl + '</div>';
                            h += '<div style="flex:1;text-align:right;font-size:13px;color:rgba(255,255,255,0.7);">' + it + '</div>';
                            h += '<div>' + methodBadge(pm) + '</div>';
                            h += '</div>';
                        });
                        h += '</div>';
                    }

                    /* Config */
                    h += '<div style="font-size:16px;font-weight:600;margin:18px 0 8px 0;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.08);">' + SVG.settings + ' Plugin Configuration</div>';
                    h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:14px 16px;margin-bottom:16px;">';
                    h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;">';
                    var cfgItems = [
                        ['Conservative Mode', V(cfg,'ConservativeMode')],
                        ['Dynamic Profiles', V(cfg,'EnableDynamicProfiles')],
                        ['Learning', V(cfg,'EnableLearning')],
                        ['Verbose Logging', V(cfg,'EnableVerboseLogging')]
                    ];
                    cfgItems.forEach(function(ci) {
                        var on = ci[1] === true;
                        h += '<div>';
                        h += '<div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:2px;">' + ci[0] + '</div>';
                        h += badge(on ? 'ON' : 'OFF', on ? 'rgba(76,175,80,0.2)' : 'rgba(255,255,255,0.06)', on ? '#4caf50' : 'rgba(255,255,255,0.35)');
                        h += '</div>';
                    });
                    var br = V(cfg,'GlobalMaxBitrateOverride');
                    h += '<div><div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:2px;">Max Bitrate</div><span style="font-size:13px;">' + (br ? Math.round(br / 1000000) + ' Mbps' : 'None') + '</span></div>';
                    var ret = V(cfg,'TelemetryRetentionDays') || 90;
                    h += '<div><div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:2px;">Retention</div><span style="font-size:13px;">' + ret + ' days</span></div>';
                    h += '</div></div>';

                    /* Clients */
                    h += '<div style="font-size:16px;font-weight:600;margin:18px 0 8px 0;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.08);">Known Clients</div>';
                    if (!clients || clients.length === 0) {
                        h += '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3);font-style:italic;">No clients seen yet. Play something to populate.</div>';
                    } else {
                        h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:12px;margin-bottom:16px;">';
                        clients.forEach(function(c) {
                            var cname = V(c,'ClientName') || 'Unknown';
                            var dname = V(c,'DeviceName') || '';
                            var ctype = V(c,'ClientType') || 0;
                            var cver = V(c,'ClientVersion') || '';
                            var rel = V(c,'ReliabilityScore');
                            if (rel === undefined) rel = 0.5;
                            var mbr = V(c,'MaxBitrate');
                            var lu = V(c,'LastUpdated');
                            var ccf = V(c,'CodecConfidence') || {};
                            var ctf = V(c,'ContainerConfidence') || {};

                            h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:16px;">';

                            /* Header row with icon */
                            h += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">';
                            h += '<div style="width:48px;height:48px;border-radius:10px;background:rgba(0,164,220,0.1);display:flex;align-items:center;justify-content:center;flex-shrink:0;">' + getIcon(ctype) + '</div>';
                            h += '<div style="flex:1;min-width:0;">';
                            h += '<div style="font-size:15px;font-weight:600;">' + cname + '</div>';
                            h += '<div style="font-size:12px;color:rgba(255,255,255,0.4);">' + dname + (cver ? ' &middot; v' + cver : '') + ' &middot; ' + badge(getTypeName(ctype), 'rgba(0,164,220,0.15)', '#00a4dc') + '</div>';
                            h += '</div></div>';

                            /* Codec confidence */
                            h += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:rgba(255,255,255,0.35);margin:8px 0 3px 0;">Codec Confidence</div>';
                            var ckeys = Object.keys(ccf);
                            if (ckeys.length === 0) {
                                h += '<div style="font-size:12px;color:rgba(255,255,255,0.25);padding:4px 0;">No data yet</div>';
                            } else {
                                ckeys.sort().forEach(function(k) { h += confBar(k, ccf[k]); });
                            }

                            /* Container confidence */
                            h += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:rgba(255,255,255,0.35);margin:10px 0 3px 0;">Container Confidence</div>';
                            var tkeys = Object.keys(ctf);
                            if (tkeys.length === 0) {
                                h += '<div style="font-size:12px;color:rgba(255,255,255,0.25);padding:4px 0;">No data yet</div>';
                            } else {
                                tkeys.sort().forEach(function(k) { h += confBar(k, ctf[k]); });
                            }

                            /* Footer stats */
                            h += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.06);font-size:12px;color:rgba(255,255,255,0.5);">';
                            h += '<span>Reliability: <strong style="color:#00a4dc;">' + Math.round(rel * 100) + '%</strong></span>';
                            if (mbr) h += '<span>Max Bitrate: <strong style="color:#00a4dc;">' + Math.round(mbr / 1000000) + ' Mbps</strong></span>';
                            if (lu) h += '<span>Last seen: <strong style="color:#00a4dc;">' + timeAgo(lu) + '</strong></span>';
                            h += '</div>';

                            h += '</div>';
                        });
                        h += '</div>';
                    }

                    /* Telemetry table */
                    h += '<div style="display:flex;align-items:center;justify-content:space-between;margin:18px 0 8px 0;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.08);">';
                    h += '<div style="font-size:16px;font-weight:600;">Recent Playback</div>';
                    h += '<label style="font-size:12px;color:rgba(255,255,255,0.5);">Lookback <select id="jpHoursSelect" style="background:rgba(255,255,255,0.06);color:inherit;border:1px solid rgba(255,255,255,0.1);border-radius:4px;padding:3px 6px;font-size:12px;margin-left:4px;">';
                    h += '<option value="1">1h</option><option value="6">6h</option><option value="24" selected>24h</option><option value="72">3d</option><option value="168">7d</option>';
                    h += '</select></label></div>';

                    h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:4px;overflow-x:auto;">';
                    if (!telemetry || telemetry.length === 0) {
                        h += '<div style="text-align:center;padding:24px;color:rgba(255,255,255,0.3);font-style:italic;">No playback events in this period.</div>';
                    } else {
                        h += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                        h += '<thead><tr>';
                        ['Time','Client','Codec','Container','Method','Result','Progress','Transcode Reasons'].forEach(function(th) {
                            h += '<th style="text-align:left;padding:8px 10px;border-bottom:2px solid rgba(255,255,255,0.08);font-weight:600;color:rgba(255,255,255,0.6);white-space:nowrap;">' + th + '</th>';
                        });
                        h += '</tr></thead><tbody>';
                        telemetry.forEach(function(o) {
                            var ts = V(o,'Timestamp');
                            var cn = V(o,'ClientName') || '';
                            var vc = V(o,'VideoCodec') || '';
                            var ac = V(o,'AudioCodec') || '';
                            var ct = V(o,'Container') || '';
                            var pm = V(o,'PlayMethod') || '';
                            var re = V(o,'Result');
                            if (re === undefined) re = 0;
                            var pt = V(o,'PlayedTicks');
                            var tt = V(o,'TotalTicks');
                            var tr = V(o,'TranscodeReasons') || '';
                            var prog = (pt && tt && tt > 0) ? Math.round(100 * pt / tt) + '%' : '';

                            h += '<tr>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);white-space:nowrap;">' + fmtTime(ts) + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);">' + cn + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);font-family:monospace;font-size:12px;">' + vc + (ac ? ' / ' + ac : '') + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);font-family:monospace;font-size:12px;">' + ct + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);">' + methodBadge(pm) + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);">' + resultBadge(re) + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);">' + prog + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:11px;color:rgba(255,255,255,0.4);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + tr + '</td>';
                            h += '</tr>';
                        });
                        h += '</tbody></table>';
                    }
                    h += '</div>';

                    /* Intervention Log */
                    h += '<div style="display:flex;align-items:center;justify-content:space-between;margin:18px 0 8px 0;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.08);">';
                    h += '<div style="font-size:16px;font-weight:600;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ff9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Intervention Log</div>';
                    h += '</div>';

                    h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:4px;overflow-x:auto;">';
                    if (!interventions || interventions.length === 0) {
                        h += '<div style="text-align:center;padding:24px;color:rgba(255,255,255,0.3);font-style:italic;">No interventions recorded in this period.</div>';
                    } else {
                        h += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                        h += '<thead><tr>';
                        ['Time','Client','Device','Status','Direct Play','Direct Stream','Transcode','Bitrate Cap','Confidence','Reasoning'].forEach(function(th) {
                            h += '<th style="text-align:left;padding:8px 10px;border-bottom:2px solid rgba(255,255,255,0.08);font-weight:600;color:rgba(255,255,255,0.6);white-space:nowrap;">' + th + '</th>';
                        });
                        h += '</tr></thead><tbody>';
                        interventions.forEach(function(iv) {
                            var ts = V(iv,'Timestamp');
                            var cn = V(iv,'ClientName') || '';
                            var dn = V(iv,'DeviceName') || '';
                            var active = V(iv,'IsActive');
                            var dp = V(iv,'AllowDirectPlay');
                            var ds = V(iv,'AllowDirectStream');
                            var tc = V(iv,'AllowTranscoding');
                            var br = V(iv,'BitrateCap');
                            var conf = V(iv,'Confidence') || 0;
                            var reason = V(iv,'Reasoning') || '';

                            var statusBadge = active
                                ? badge('ACTIVE', 'rgba(76,175,80,0.2)', '#4caf50')
                                : badge('DRY RUN', 'rgba(255,152,0,0.15)', '#ff9800');

                            var boolBadge = function(val) {
                                return val
                                    ? '<span style="color:#4caf50;">&#10003;</span>'
                                    : '<span style="color:#f44336;">&#10007;</span>';
                            };

                            h += '<tr>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);white-space:nowrap;">' + fmtTime(ts) + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);">' + cn + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);">' + dn + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);">' + statusBadge + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center;">' + boolBadge(dp) + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center;">' + boolBadge(ds) + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center;">' + boolBadge(tc) + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);font-family:monospace;font-size:12px;">' + (br ? Math.round(br / 1000000) + ' Mbps' : '—') + '</td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);">';
                            h += '<div style="display:flex;align-items:center;gap:6px;">';
                            h += '<div style="width:40px;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;"><div style="width:' + Math.round(conf * 100) + '%;height:100%;background:' + barColor(Math.round(conf * 100)) + ';border-radius:3px;"></div></div>';
                            h += '<span style="font-family:monospace;font-size:11px;">' + Math.round(conf * 100) + '%</span>';
                            h += '</div></td>';
                            h += '<td style="padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:11px;color:rgba(255,255,255,0.4);max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + reason.replace(/"/g, '&quot;') + '">' + reason.split('\n')[0] + '</td>';
                            h += '</tr>';
                        });
                        h += '</tbody></table>';
                    }
                    h += '</div>';

                    document.getElementById('jpRoot').innerHTML = h;
                    document.getElementById('jpUpdatedAt').textContent = 'Updated ' + new Date().toLocaleTimeString();
                    document.getElementById('jpRefresh').addEventListener('click', loadDashboard);
                    var sel = document.getElementById('jpHoursSelect');
                    if (sel) sel.addEventListener('change', loadDashboard);
                }

                function loadDashboard() {
                    var hoursEl = document.getElementById('jpHoursSelect');
                    var hours = hoursEl ? hoursEl.value : 24;
                    Promise.all([
                        fetchJ('/TuneCast/Dashboard/Summary'),
                        fetchJ('/TuneCast/Dashboard/Clients'),
                        fetchJ('/TuneCast/Dashboard/Telemetry?hours=' + hours),
                        fetchJ('/TuneCast/Dashboard/Interventions?hours=' + hours)
                    ]).then(function(r) {
                        render(r[0], r[1], r[2], r[3]);
                    }).catch(function(err) {
                        document.getElementById('jpRoot').innerHTML =
                            '<div style="color:#f44336;padding:20px;">Error loading dashboard: ' + err.message + '</div>';
                    });
                }

                document.querySelector('#TuneCastDashboardPage')
                    .addEventListener('pageshow', loadDashboard);
            })();
        </script>
    </div>
</body>
</html>
